name: Daily NBA run

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 13 * * *"  # 13:00 UTC every day

jobs:
  run-nba-pipeline:
    runs-on: ubuntu-latest

    env:
      # API keys from GitHub Actions secrets
      RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}           # API-Sports
      ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}           # The Odds API
      BALLDONTLIE_API_KEY: ${{ secrets.BALLDONTLIE_API_KEY }}  # balldontlie (for training if ever needed)
      PYTHONPATH: .
      # Optional: set RUN_DATE="YYYY-MM-DD" to backfill a specific date
      # RUN_DATE: "2025-12-06"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests pyyaml scikit-learn lightgbm joblib

      - name: Ensure runtime folders
        run: |
          mkdir -p data/_snapshots
          mkdir -p outputs

      # ===================== Odds snapshots + dispersion =====================
      - name: Save OPEN odds snapshot
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          PYTHONPATH: .
          SNAPSHOT_KIND: open
        run: |
          python src/ingest/odds_snapshots.py

      - name: Save MID odds snapshot
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          PYTHONPATH: .
          SNAPSHOT_KIND: mid
        run: |
          python src/ingest/odds_snapshots.py

      - name: Save CLOSE odds snapshot
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          PYTHONPATH: .
          SNAPSHOT_KIND: close
        run: |
          python src/ingest/odds_snapshots.py

      - name: Build odds movement & dispersion
        env:
          PYTHONPATH: .
        run: |
          python - << 'PY'
          import os, glob
          from src.ingest.odds_snapshots import compute_movement, compute_dispersion

          snap_dir = "data/_snapshots"
          os.makedirs("outputs", exist_ok=True)

          snaps = sorted(glob.glob(os.path.join(snap_dir, "*.csv")))
          latest_open = None
          latest_close = None
          for p in snaps:
              base = os.path.basename(p)
              if base.startswith("open_"):
                  latest_open = p
              elif base.startswith("close_"):
                  latest_close = p

          if latest_open and latest_close:
              movement = compute_movement(latest_open, latest_close)
              movement.to_csv("outputs/odds_movement_latest.csv", index=False)
              dispersion = compute_dispersion(latest_close)
              dispersion.to_csv("outputs/odds_dispersion_latest.csv", index=False)
              print("wrote odds_movement_latest.csv and odds_dispersion_latest.csv")
          else:
              print("No open/close pair found; skipping odds feature build.")
          PY
      # =====================================================================

      - name: Run QA
        run: |
          python qa/validation.py

      # ===================== NEW: End-to-end daily pipeline ==================
      - name: Run daily NBA Pro-Lite pipeline
        run: |
          python run_daily.py
      # ======================================================================

      - name: Evaluate + Calibrate
        env:
          PYTHONPATH: .
          # RUN_DATE (if set at job-level) will be inherited automatically
        run: |
          python src/eval/calibration.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nba-run
          path: |
            outputs/
            run_summary.md
            calibration_report.html
            outputs/picks_*.csv
            picks_report.html
